#!/system/bin/sh

# èŽ·å–è„šæœ¬çš„ç»å¯¹è·¯å¾„å’Œç›®å½•
scripts=$(realpath $0)
scripts_dir=$(dirname ${scripts})
# å¯¼å…¥Clashçš„é…ç½®æ–‡ä»¶
source /data/clash/clash.config

# ä¸‹è½½é…ç½®æ–‡ä»¶çš„å‡½æ•°
dow_config() {
  if [ "${config_online}" = "true" ] ; then
    # æ£€æŸ¥æ˜¯å¦ç¦ç”¨äº†Clash
    if ! [ "$(head -1 ${Clash_run_path}/root)" = "disable" ] ; then
      # ä½¿ç”¨clash.toolå·¥å…·ä¸‹è½½é…ç½®æ–‡ä»¶
      if ! (${scripts_dir}/clash.tool -o) ; then
        log "[error] ä¸‹è½½é…ç½®æ–‡ä»¶å¤±è´¥"
        log "[error] ç¡®ä¿ç½‘ç»œè¿žæŽ¥æ­£å¸¸" && exit 1
      fi
    fi
  fi
}

# æ›¿æ¢å†…æ ¸çš„å‡½æ•°
replace_kernel() {
  # ä¿®æ”¹æ–‡ä»¶æƒé™å¹¶åˆ é™¤æ—§çš„clashäºŒè¿›åˆ¶æ–‡ä»¶
  chmod 0755 ${Clash_lib}/* && rm -rf ${Clash_bin}/clash
  err="æ›´æ¢å†…æ ¸å¤±è´¥ã€‚"
  if [ "${use_premium}" = "true" ] ; then
    # å¦‚æžœä½¿ç”¨Clash Premiumï¼Œåˆ™å¤åˆ¶Premiumç‰ˆæœ¬çš„äºŒè¿›åˆ¶æ–‡ä»¶
    cp -f ${Clash_Premium} ${Clash_bin}/clash && echo "" || log "[error] ${err}"
  else
    # å¦‚æžœä½¿ç”¨Clash Metaï¼Œåˆ™å¤åˆ¶Metaç‰ˆæœ¬çš„äºŒè¿›åˆ¶æ–‡ä»¶
    cp -f ${Clash_Meta} ${Clash_bin}/clash && echo "" || log "[error] ${err}"
  fi
}

# ä½¿ç”¨Clashçš„å‡½æ•°
use_clash() {
  # æ ¹æ®é…ç½®ä½¿ç”¨Clash Premiumæˆ–Clash Metaï¼Œå¹¶è¾“å‡ºç›¸åº”ä¿¡æ¯
  [ "${use_premium}" = "true" ] \
  && log "[info] â˜‘ å¯ç”¨ Clash Premiumå†…æ ¸" \
  && log "[warning] ä½¿ç”¨Premiumå†…æ ¸å‰è¯·å…ˆæ‰‹åŠ¨åˆ é™¤" \
  && log "[warning] templateæ–‡ä»¶ä¸­æœªé€‚é…Pæ ¸çš„é…ç½®é¡¹ç›®" \
  && log "[warning] å¦åˆ™På†…æ ¸å°†æ— æ³•æ­£å¸¸å¯åŠ¨" \
  || log "[info] â˜‘ å¯ç”¨ Clash Metaå†…æ ¸"
  if [ ! -f "${Clash_bin_path}" ] ; then
    log "[error] æ‰¾ä¸åˆ°å†…æ ¸ ${Clash_bin_path}"
    exit 1
  fi
  log "[info] ä½¿ç”¨é…ç½®æ–‡ä»¶ ${Clash_config_file}."
}


# æ£€æŸ¥ClashæœåŠ¡æ˜¯å¦ä»åœ¨è¿è¡Œçš„å‡½æ•°
ceks_clash() {
  local PID=$(pidof clash 2> /dev/null)
  if (cat /proc/${PID}/cmdline | grep -q ${Clash_bin_name}) ; then
    log "[warning] Clash æœåŠ¡æ­£åœ¨è¿è¡Œ" && exit 1
  fi
}

# æ£€æµ‹tunè®¾å¤‡æ˜¯å¦å­˜æ´»çš„å‡½æ•°
tun_alive() {
  mkdir -p /dev/net
  [ ! -L /dev/net/tun ] && ln -sf /dev/tun /dev/net/tun
}

# é…ç½®tunè®¾å¤‡ç”¨äºŽtproxyçš„å‡½æ•°
tun_tproxy() {
  if [ "${Clash_tun_status}" = "true" ] ; then
    if [ ${arm} = "aarch64" ] ; then
      tun_alive
      log "[info] å¯ç”¨ TUN æ¨¡å¼ä»£ç†æ–¹å¼: [${Clash_stack_mode}] "
      log "[info] åˆ›å»º /dev/net/tun."
      sed -i 's/auto-detect-interface:.*/auto-detect-interface: true/' ${Clash_template}
      sed -i 's/auto-route:.*/auto-route: true/' ${Clash_template}
      sed -i 's/tproxy-port:.*/tproxy-port: 0/' ${Clash_template}
      sed -i 's/network_mode=.*/network_mode="MIXED"/' /data/clash/clash.config
    else
      log "[error] TUNæ¨¡å¼åªæ”¯æŒarm64/armv8" && exit 1
    fi
  else
    sed -i 's/auto-detect-interface:.*/auto-detect-interface: false/' ${Clash_template}
    sed -i 's/auto-route:.*/auto-route: false/' ${Clash_template}
    sed -i 's/tproxy-port:.*/tproxy-port: 9898/' ${Clash_template}
    sed -i 's/network_mode=.*/network_mode="UDP"/' /data/clash/clash.config
    log "[info] å¯ç”¨ TProxy æ¨¡å¼."
  fi
}

# ç”Ÿæˆä¸´æ—¶é…ç½®æ–‡ä»¶çš„å‡½æ•°
temporary_config_file() {
  if [ -f "${Clash_template}" ] ; then
    if [ -f "${Clash_config_file}" ] ; then
      cp -f ${Clash_template} ${temporary_config_file}.temp && echo "\n" >> ${temporary_config_file}.temp
      sed -n -E '/^proxies:$/,$p' ${Clash_config_file} >> ${temporary_config_file}.temp
      sed -i '/^[  ]*$/d' ${temporary_config_file}.temp
    else
      log "[error] ${Clash_config_file} æ–‡ä»¶ä¸å­˜åœ¨" && exit 1
    fi
  else
    log "[error] ${Clash_template} æ–‡ä»¶ä¸å­˜åœ¨" && exit 1
  fi

  mv ${temporary_config_file}.temp ${temporary_config_file} \
  && log "[info] åˆå¹¶ ${Clash_config_file} &æ¨¡æ¿æˆåŠŸ" || log "[error] åˆå¹¶ ${Clash_config_file} & æ¨¡æ¿å¤±è´¥"

  if [ ! -f "${temporary_config_file}" ] ; then
     log "[error] æ‰¾ä¸åˆ° ${temporary_config_file} æ— æ³•å¯åŠ¨" && exit 1
  fi
}

# è®¾ç½®å®šæ—¶ä»»åŠ¡çš„ç§’æ•°
crontab_sec() {
  if [ ! "${schedule_update_core}" = "false" ] ; then
    echo "${schedule_update_core} ${scripts_dir}/clash.tool -k > /data/clash/run/update.log 2>&1" >> ${Clash_run_path}/root
    log "[info] å®šæ—¶æ›´æ–°å†…æ ¸ [${schedule_update_core}]"
    log "[info] æ›´æ–°å†…æ ¸å·²å¯ç”¨ â˜‘ã€‚"
  fi
  if [ ! "${update_interval}" = "false" ] ; then
    echo "${update_interval} ${scripts_dir}/clash.tool -s > /data/clash/run/update.log 2>&1" >> ${Clash_run_path}/root
    log "[info] å®šæ—¶æ›´æ–°Geoæ•°æ®å’Œè®¢é˜…æ—¶é—´ [${update_interval}]"
    log "[info] è‡ªåŠ¨æ›´æ–°Geoæ•°æ® ï¼š [${auto_updateGeoX}]"
    log "[info] è‡ªåŠ¨æ›´æ–°è®¢é˜… ï¼š[${auto_updateSubcript}]"
  else
    log "[info] å®šæ—¶æ›´æ–°Geoæ•°æ®åº“å’Œè®¢é˜…å·²ç¦ç”¨ â˜’"
  fi
}

# æå–æˆåŠŸæ—¥å¿—çš„å‡½æ•°
log_suc() {
  echo "â”â”â”â”â”â”â”â”â”â”å†…æ ¸æ—¥å¿—â”â”â”â”â”â”â”â”â”â”â”" >> ${CFM_logs_file}
  sed -i s/.*msg=// ${Clash_run_path}/start.log
  sed -i 's/configuration file*//' ${Clash_run_path}/start.log
  sed -E 's/[36mINFO[0m\[[0-9]{4}-[0-9]{2}-[0-9]{2}T[0-9]{2}:[0-9]{2}:[0-9]{2}\.[0-9]{3}Z\]//g' ${Clash_run_path}/start.log
  sed -E 's/[33mWARN[0m\[[0-9]{4}-[0-9]{2}-[0-9]{2}T[0-9]{2}:[0-9]{2}:[0-9]{2}\.[0-9]{3}Z\]//g' ${Clash_run_path}/start.log
  sed -E 's/[31mERRO[0m\[[0-9]{4}-[0-9]{2}-[0-9]{2}T[0-9]{2}:[0-9]{2}:[0-9]{2}\.[0-9]{3}Z\]//g' ${Clash_run_path}/start.log
  while read p ; do
    log "[info]" "$p"
  done <${Clash_run_path}/start.log
  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" >> ${CFM_logs_file}
}

# æå–å¤±è´¥æ—¥å¿—çš„å‡½æ•°
log_failed() {
  log "[error] å¯åŠ¨å¤±è´¥ï¼Œè¯·æ£€æŸ¥å†…æ ¸æŠ¥é”™å¹¶ä¿®æ”¹é…ç½®"
  log "[error] å½“å‰é…ç½®ï¼š${Clash_config_file}"
  echo "â”â”â”â”â”â”â”â”â”â”å†…æ ¸æ—¥å¿—â”â”â”â”â”â”â”â”â”â”â”" >> ${CFM_logs_file}
  sed -i s/.*msg=// ${Clash_run_path}/start.log
  sed -i 's/fatal msg=*//' ${Clash_run_path}/start.log
  sed -i 's/configuration file*//' ${Clash_run_path}/start.log
  sed -E 's/[36mINFO[0m\[[0-9]{4}-[0-9]{2}-[0-9]{2}T[0-9]{2}:[0-9]{2}:[0-9]{2}\.[0-9]{3}Z\]//g' ${Clash_run_path}/start.log
  sed -E 's/[33mWARN[0m\[[0-9]{4}-[0-9]{2}-[0-9]{2}T[0-9]{2}:[0-9]{2}:[0-9]{2}\.[0-9]{3}Z\]//g' ${Clash_run_path}/start.log
  sed -E 's/[31mERRO[0m\[[0-9]{4}-[0-9]{2}-[0-9]{2}T[0-9]{2}:[0-9]{2}:[0-9]{2}\.[0-9]{3}Z\]//g' ${Clash_run_path}/start.log
  while read p ; do
    log "[error]" "$p"
  done <${Clash_run_path}/start.log
  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" >> ${CFM_logs_file}
}

# å¯åŠ¨Clashçš„å‡½æ•°
run_clash() {
  ${Clash_bin_path} -t -d ${Clash_data_dir} -f ${temporary_config_file} > ${Clash_run_path}/start.log
  if [ "$?" = "0" ] ; then
    ulimit -SHn 1000000
    nohup ${busybox_path} setuidgid 0:3005 ${Clash_bin_path} -d ${Clash_data_dir} -f ${temporary_config_file} > ${Clash_run_path}/output-clash.log 2>&1 &
    echo -n $! > ${Clash_pid_file}
    log_suc
  else
    log_failed
    [ "${use_config}" = "false" ] \
    && (mv ${temporary_config_file} ${Clash_data_dir}/config.yaml) || (mv ${temporary_config_file} ${Clash_data_dir}/${use_config})
    exit 1
  fi
  #rm -rf ${Clash_run_path}/start.log
}

# è®¾ç½®cgroupé™åˆ¶çš„å‡½æ•°
cgroup_limit() {
  if [ "${Cgroup_memory}" = "true" ] ; then
    [ "${scripts_dir}/clash.tool -l" ] \
    && log "[warning] å†…æ ¸ä¸æ”¯æŒcgroup" || log "[info] cgroupé™åˆ¶: ${Cgroup_memory_limit}"
  fi
}

# å¯åŠ¨Clashçš„å‡½æ•°
start_clash() {
  dow_config
  replace_kernel
  echo $(date) > ${CFM_logs_file}
  echo "$(${Clash_bin_path} -v)" >> ${CFM_logs_file}
  echo "Clash for Magisk v3.0" > /dev/null
  echo "CPU: % | RES: kb" >> ${CFM_logs_file}
  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" >> ${CFM_logs_file}
  if [ "${ipv6}" = "false" ] ; then
    echo 0 > /proc/sys/net/ipv6/conf/all/accept_ra
    echo 0 > /proc/sys/net/ipv6/conf/wlan0/accept_ra
    echo 1 > /proc/sys/net/ipv6/conf/all/disable_ipv6
    echo 1 > /proc/sys/net/ipv6/conf/default/disable_ipv6
    echo 1 > /proc/sys/net/ipv6/conf/wlan0/disable_ipv6
    log "[info] IPv6: â˜’ ç¦ç”¨"
  else
    echo 1 > /proc/sys/net/ipv6/conf/all/accept_ra
    echo 1 > /proc/sys/net/ipv6/conf/wlan0/accept_ra
    echo 0 > /proc/sys/net/ipv6/conf/all/disable_ipv6
    echo 0 > /proc/sys/net/ipv6/conf/default/disable_ipv6
    echo 0 > /proc/sys/net/ipv6/conf/wlan0/disable_ipv6
    log "[info] IPv6: â˜‘ å¯ç”¨"
  fi
  use_clash
  ceks_clash
  tun_tproxy
  temporary_config_file

  if [ -f "${Clash_bin_path}" ] ; then
    chown 0:3005 ${Clash_bin_path} && chown 0:3005 ${temporary_config_file}
    chmod 0700 ${Clash_bin_path} && chmod 0700 ${temporary_config_file}
    rm -rf ${Clash_run_path}/crond.log
    nohup ${busybox_path} crond -L ${Clash_run_path}/crond.log -c ${Clash_run_path} > /dev/null 2>&1 &
    ${busybox_path} crontab -c ${Clash_run_path} -r
    touch ${Clash_run_path}/root
    chmod 0600 ${Clash_run_path}/root
    crontab_sec
  else
    log "[error] Clashå†…æ ¸æ–‡ä»¶ ${Clash_bin_path} ä¸¢å¤±" && exit 1
  fi

  if [ -f ${temporary_config_file} ] ; then
    if (${Clash_bin_path} -v > /dev/null 2>&1) ; then
      run_clash
      cgroup_limit
      [ "$run_usage" = "true" ] \
      && (nohup ${scripts_dir}/usage.sh > /dev/null 2>&1 &) || log "[info] æ˜¾ç¤ºä½¿ç”¨æƒ…å†µ RES:/CPU: å·²ç¦ç”¨"
    else
      log "[error] Clashå†…æ ¸é”™è¯¯/æŸå/ä¸å—æ”¯æŒ" && exit 1
    fi
  else
    log "[error] ${Clash_config_file} æ–‡ä»¶ä¸¢å¤±" && exit 1
  fi
}

# ç»ˆæ­¢Clashçš„å‡½æ•°
kill_tool() {
  cronkill=$(ps -ef | grep root | grep "crond -L /data/clash/run/crond.log" | ${busybox_path} awk '{ print $2 }' | sort -u)
  for cron in ${cronkill[*]} ; do
     kill -9 ${cron}
  done
  if (kill -9 $(cat ${Clash_run_path}/dnstt.pid)) ; then
    rm -rf ${Clash_run_path}/dnstt.pid
    log "[warning] ${dnstt_bin_name} å·²å…³é—­"
  fi
}

# åœæ­¢Clashçš„å‡½æ•°
stop_clash() {
  kill_tool
  if (kill -9 $(pidof clash) || killall -9 clash) ; then
    rm -rf ${Clash_pid_file}
    sleep 0.75
    [ $(pidof clash) ] \
    && log "[warning] Clashå†…æ ¸å…³é—­å¤±è´¥" || log "[warning] Clashå†…æ ¸å·²å…³é—­"
    [ ! $(pidof clash) ] && log "[warning] Clashæ¨¡å—å·²åœæ­¢è¿è¡Œ"
  else
    log "[error] åœæ­¢Clashå¤±è´¥"
  fi
}

# è§£æžå‘½ä»¤è¡Œå‚æ•°
while getopts ":sk" signal ; do
  case ${signal} in
    s)
      stop_clash >> /dev/null 2>&1
      time start_clash
      ;;
    k)
      time stop_clash
      ;;
    ?)
      echo ""
      ;;
  esac
done
